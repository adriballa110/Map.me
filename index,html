<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Globo 3D - Let&#39;s Imagine</title>

  <!-- three.js -->
  <script src="https://unpkg.com/three@0.156.0/build/three.min.js"></script>

  <!-- d3 (necessario per globe.gl) -->
  <script src="https://unpkg.com/d3@7"></script>

  <!-- globe.gl (usa three.js internamente) -->
  <script src="https://unpkg.com/globe.gl@2.26.4"></script>

  <style>
    html,body {
      height:100%;
      margin:0;
      background:#081229;
      font-family: Arial, Helvetica, sans-serif;
      -webkit-font-smoothing:antialiased;
    }
    #globeViz {
      width:100%;
      height:100vh; /* full viewport */
      display:block;
      position:relative;
    }
    .legend {
      position:absolute;
      left:10px;
      top:10px;
      z-index:10;
      background:rgba(255,255,255,0.85);
      padding:8px 10px;
      border-radius:8px;
      box-shadow:0 2px 8px rgba(0,0,0,0.3);
      font-size:14px;
    }
    .marker {
      border-radius:50%;
      width:12px;
      height:12px;
      border:2px solid #fff;
      background:#ff5722;
      box-shadow:0 0 6px #ff5722;
    }
    .popup {
      position:absolute;
      background:rgba(0,0,0,0.75);
      color:#fff;
      padding:8px 10px;
      border-radius:6px;
      pointer-events:none;
      transform:translate(-50%,-120%);
      font-size:13px;
    }
  </style>
</head>
<body>
  <div id="globeViz"></div>

  <script>
    // --- dati dei marker di esempio (puoi personalizzare) ---
    const places = [
      { id: 1, name: "New York", lat: 40.7128, lng: -74.0060 },
      { id: 2, name: "Roma", lat: 41.9028, lng: 12.4964 },
      { id: 3, name: "Tokyo", lat: 35.6762, lng: 139.6503 },
      { id: 4, name: "Maldive", lat: 3.2028, lng: 73.2207 },
    ];

    // --- crea il globo ---
    const Globe = GlobeGL()
      (document.getElementById('globeViz'))
      .globeImageUrl('https://raw.githubusercontent.com/ambix/earth-globe-textures/main/earth-night.jpg') // texture HD via CDN pubblico
      .bumpImageUrl('https://raw.githubusercontent.com/iamrdn/earth-textures/main/earth-normal.png') // optional normal map
      .showAtmosphere(true)
      .atmosphereColor("#0f7eff")
      .atmosphereAltitude(0.4)
      .backgroundColor('#081229')
      .enablePointerInteraction(true)
      .onGlobeReady(() => {
        // impostazioni iniziali camera
        Globe.pointOfView({ lat: 20, lng: 0, altitude: 2.5 }, 0);
      });

    // aggiungi markers come "objects"
    Globe
      .pointsData(places)
      .pointLat('lat')
      .pointLng('lng')
      .pointAltitude(0.01)
      .pointRadius(0.02)
      .pointColor(() => '#ff5722')
      .pointsMerge(true)
      .onPointClick(point => {
        // quando clicchi un marker: apri popup o invia message via URL (vedi nota)
        alert('Hai cliccato: ' + point.name);
      });

    // abilita drag e zoom (di default GlobeGL lo gestisce)
    // puoi personalizzare velocità rotazione automatica se vuoi:
    let autoRotate = true;
    let rotationSpeed = 0.02; // più basso = più lento
    function animate() {
      if (autoRotate) {
        const cur = Globe.pointOfView();
        Globe.pointOfView({ lat: cur.lat, lng: cur.lng + rotationSpeed, altitude: cur.altitude }, 10);
      }
      requestAnimationFrame(animate);
    }
    // commenta se non vuoi la rotazione automatica
    animate();

    // --- gestione popup visivo (opzionale) ---
    const popup = document.createElement('div');
    popup.className = 'popup';
    popup.style.display = 'none';
    document.body.appendChild(popup);

    Globe.onPointHover(point => {
      if (!point) { popup.style.display = 'none'; return; }
      popup.style.display = 'block';
      popup.innerText = point.name;
      // posizionamento: usa getBoundingClientRect del canvas per mappare pos
      const canvas = document.querySelector('#globeViz canvas');
      if (!canvas) return;
      const rect = canvas.getBoundingClientRect();
      // calcola posizione approssimativa al centro del canvas (non perfetto, ma funziona)
      popup.style.left = (rect.left + rect.width/2) + 'px';
      popup.style.top = (rect.top + rect.height/2) + 'px';
    });

    // --- funzione utili per inviare messaggi all'app (opzionale) ---
    function notifyHost(action, payload) {
      const message = { action, payload };
      // invio via URL change (semplice) -> Flutter può ascoltare cambi di URL nel WebView
      window.location.href = 'myapp://message?' + encodeURIComponent(JSON.stringify(message));
    }

    // esempio: al click di un marker useremo notifyHost invece di alert
    // Globe.onPointClick(point => notifyHost('pointClick', point));
  </script>
</body>
</html>
